{% load static %}
{% load opencve_extras %}

<div class="nav-tabs-custom nav-tabs-primary">
    <ul class="nav nav-tabs">
        <li class="active">
            <a href="#mitre" data-toggle="tab"> <img src="{% static 'img/cve-icon.png' %}" style="margin-top: -2px; width: 32px;" class="provider-icon" alt="cve-icon" /> Mitre Data</a>
        </li>
        <li>
            <a href="#nvd" data-toggle="tab"> <img src="{% static 'img/nvd-icon.png' %}" style="margin-top: -2px; width: 32px;" class="provider-icon" alt="cve-icon" /> CPE Configurations</a>
        </li>
        <li>
            <a href="#redhat" data-toggle="tab"> <img src="{% static 'img/redhat-icon.png' %}" style="margin-top: -2px; width: 20px;" class="provider-icon" alt="cve-icon" /> Affected Packages</a>
        </li>
        <li>
            <a href="#enrichment" data-toggle="tab"> <img src="{% static 'img/opencve_32.png' %}" style="margin-top: -2px; width: 20px;" class="provider-icon" alt="cve-icon" /> OpenCVE Enrichment</a>
        </li>
    </ul>
    <div class="tab-content">
        <div class="tab-pane active" id="mitre">
            {% if cve.mitre_json and cve.mitre_json.containers.cna.affected %}
            <p class="text-muted small mb-3">
              <strong>Default status</strong> is the baseline for the product, each <strong>version</strong> can override it (e.g. patched versions marked unaffected).
            </p>
            <div id="mitre-affected-wrapper" class="mitre-affected-wrapper" data-initial-rows="5">
              <table class="table table-condensed" id="mitre-affected-table">
                <thead>
                  <tr>
                    <th>Vendor</th>
                    <th>Product</th>
                    <th>Default status</th>
                    <th>Versions</th>
                  </tr>
                </thead>
                <tbody>
                {% for affected in cve.mitre_json.containers.cna.affected %}
                  <tr class="mitre-affected-row">
                    <td>{{ affected.vendor }}</td>
                    <td>{{ affected.product }}</td>
                    <td>
                      <span class="label
                        {% if affected.defaultStatus|default:"affected"|slugify == 'affected' %}label-danger
                        {% elif affected.defaultStatus|default:"affected"|slugify == 'unaffected' %}label-success
                        {% else %}label-default{% endif %}">
                        {{ affected.defaultStatus|default:"affected" }}
                      </span>
                    </td>
                    <td>
                      {% if affected.versions %}
                        <table class="table table-sm table-borderless mb-0 small">
                          <thead class="table-light">
                            <tr>
                              <th>Version</th>
                              <th>Status</th>
                              <th>Constraints</th>
                            </tr>
                          </thead>
                          <tbody>
                          {% for version in affected.versions %}
                            <tr>
                              <td class="text-break"><code>{{ version.version }}</code></td>
                              <td>
                                <span class="label {% if version.status|default:''|slugify == 'affected' %}label-danger{% elif version.status|default:''|slugify == 'unaffected' %}label-success{% else %}label-default{% endif %}">{{ version.status }}</span>
                              </td>
                              <td class="text-muted">
                                {% if version.lessThan %}< {{ version.lessThan }}{% endif %}
                                {% if version.lessThanOrEqual %}≤ {{ version.lessThanOrEqual }}{% endif %}
                                {% if not version.lessThan and not version.lessThanOrEqual %}—{% endif %}
                              </td>
                            </tr>
                          {% endfor %}
                          </tbody>
                        </table>
                      {% else %}
                        <span class="text-muted">—</span>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
                </tbody>
              </table>
              <div class="text-center mitre-see-more-wrap" id="mitre-see-more-wrap" style="display: none;">
                <button type="button" class="btn btn-default btn-sm mitre-see-more-btn" id="mitre-see-more-btn" data-label-more="See more" data-label-less="See less">See more</button>
              </div>
            </div>
            {% endif %}
        </div>

        <div class="tab-pane" id="nvd">
            {% if cve.nvd_json and cve.nvd_json.configurations %}

            {% for conf in cve.nvd_json.configurations %}
            <p><strong>Configuration {{ forloop.counter }}</strong> <a class="pointer config-toggle"
                                                                       id="config-{{ forloop.counter }}">[-]</a></p>
            <table class="table table-configuration" id="config-{{ forloop.counter }}-table">
                <tr>
                    {% if conf.operator == "AND" %}
                    <td class="col-md-1 rowspaned">AND</td>
                    {% endif %}
                    <td class="col-md-11 and">
                        {% for node in conf.nodes %}
                        <table class="table table-bordered no-margin-bottom">
                            {% for cpe in node.cpeMatch %}
                            <tr>
                                {% if forloop.counter == 1 and node.cpeMatch|length > 1 %}
                                <td class="col-md-1 rowspaned" rowspan="{{ node.cpeMatch|length }}">OR</td>
                                {% endif %}
                                <td>{{ cpe.criteria }}</td>
                            </tr>
                            {% endfor %}
                        </table>
                        {% endfor %}
                    </td>
                </tr>
            </table>
            <hr/>
            {% endfor %}

            {% else %}
            <p class="alert alert-info">No data.</p>
            {% endif %}
        </div>
        <div class="tab-pane" id="redhat">
            {% if cve.redhat_json and cve.redhat_json.affected_release %}
            {% regroup cve.redhat_json.affected_release by product_name as packages %}
            <table class="table table-striped table-bordered">
                <thead>
                    <th>Package</th>
                    <th>CPE</th>
                    <th>Advisory</th>
                    <th>Released Date</th>
                </thead>
                <tbody>
                    {% for package in packages %}
                    <tr>
                        <td colspan="4" class="td-grouper"><strong>{{ package.grouper }}</strong></td>
                    </tr>
                    {% for release in package.list %}
                    <tr>
                        <td>{{ release.package }}</td>
                        <td>{{ release.cpe }}</td>
                        <td><a href="https://access.redhat.com/errata/{{ release.advisory }}" target="_blank">{{ release.advisory }}</a></td>
                        <td>{{ release.release_date }}</td>
                    </tr>
                    {% endfor %}
                    {% endfor %}
                </tbody>


                </tbody>
            </table>
            {% else %}
            <p class="alert alert-info">No data.</p>
            {% endif %}
        </div>
        <div class="tab-pane" id="enrichment">
            {% if cve.enrichment_json %}
            <p class="alert alert-info">
                <strong>OpenCVE Enrichment</strong> is a feature of OpenCVE that uses AI to automatically link vendors and products to CVEs. <a href="https://github.com/opencve/opencve-enrichment/tree/main" target="_blank" rel="noopener">Learn more on GitHub</a>.
            </p>
            {% include "cves/includes/subscriptions.html" with vendors_dict=enrichment_vendors vendors_data_dict=enrichment_vendors_data %}
            {% else %}
            <p class="alert alert-info">No data.</p>
            {% endif %}
        </div>
    </div>
</div>

<div class="box box-primary">
  <div class="box-header">
    <h3 class="box-title">Project Subscriptions</h3>
  </div>
  <div class="box-body">
    {% include "cves/includes/subscriptions.html" with vendors_dict=vendors vendors_data_dict=vendors_data %}
  </div>
</div>
